name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: Build Universal Binary
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "6.2"
      
      - name: Build for arm64 (native)
        run: |
          swift build -c release
          mkdir -p dist/arm64
          # Find built executables
          YANKO_BIN=$(find .build -name "yankovinator" -type f | head -1)
          KEYWORD_BIN=$(find .build -name "keyword-generator" -type f | head -1)
          BENCHMARK_BIN=$(find .build -name "benchmark" -type f | head -1)
          if [ -z "$YANKO_BIN" ] || [ -z "$KEYWORD_BIN" ]; then
            echo "Error: Could not find built binaries"
            find .build -type f -name "*yankovinator*" -o -name "*keyword*" -o -name "*benchmark*" | head -10
            exit 1
          fi
          cp "$YANKO_BIN" dist/arm64/yankovinator
          cp "$KEYWORD_BIN" dist/arm64/keyword-generator
          if [ -n "$BENCHMARK_BIN" ]; then
            cp "$BENCHMARK_BIN" dist/arm64/benchmark
            chmod +x dist/arm64/benchmark
          fi
          chmod +x dist/arm64/yankovinator dist/arm64/keyword-generator
          file dist/arm64/yankovinator
      
      - name: Build for x86_64 (via Rosetta)
        run: |
          # Clean build directory for x86_64 build
          rm -rf .build
          # Build using Rosetta
          arch -x86_64 swift build -c release
          mkdir -p dist/x86_64
          # Find built executables
          YANKO_BIN=$(find .build -name "yankovinator" -type f | head -1)
          KEYWORD_BIN=$(find .build -name "keyword-generator" -type f | head -1)
          BENCHMARK_BIN=$(find .build -name "benchmark" -type f | head -1)
          if [ -n "$YANKO_BIN" ] && [ -n "$KEYWORD_BIN" ]; then
            cp "$YANKO_BIN" dist/x86_64/yankovinator
            cp "$KEYWORD_BIN" dist/x86_64/keyword-generator
            if [ -n "$BENCHMARK_BIN" ]; then
              cp "$BENCHMARK_BIN" dist/x86_64/benchmark
              chmod +x dist/x86_64/benchmark
            fi
            chmod +x dist/x86_64/yankovinator dist/x86_64/keyword-generator
            file dist/x86_64/yankovinator
          else
            echo "Warning: x86_64 build not found. Will use arm64 binary (works via Rosetta on Intel)"
            echo "Build directory contents:"
            find .build -type f | head -20
          fi
      
      - name: Verify binaries
        run: |
          file dist/arm64/yankovinator
          file dist/arm64/keyword-generator
          file dist/x86_64/yankovinator || echo "x86_64 build may need adjustment"
          file dist/x86_64/keyword-generator || echo "x86_64 build may need adjustment"
      
      - name: Create binary archives
        run: |
          cd dist/arm64
          tar -czf ../yankovinator-arm64.tar.gz yankovinator keyword-generator
          cd ../x86_64
          tar -czf ../yankovinator-x86_64.tar.gz yankovinator keyword-generator 2>/dev/null || echo "x86_64 archive creation skipped"
          cd ../..
      
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: platform-binaries
          path: |
            dist/arm64
            dist/x86_64
            dist/*.tar.gz
          retention-days: 30

  create-universal:
    name: Create Universal Binary
    runs-on: macos-14
    needs: build
    
    steps:
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: platform-binaries
          path: dist
      
      - name: Create universal binaries
        run: |
          mkdir -p dist/universal
          
          # Check if x86_64 binaries exist
          if [ -f dist/x86_64/yankovinator ] && [ -f dist/x86_64/keyword-generator ]; then
            # Create universal binaries using lipo
            lipo -create \
              dist/x86_64/yankovinator \
              dist/arm64/yankovinator \
              -output dist/universal/yankovinator
            lipo -create \
              dist/x86_64/keyword-generator \
              dist/arm64/keyword-generator \
              -output dist/universal/keyword-generator
            # Create universal benchmark if available
            if [ -f dist/x86_64/benchmark ] && [ -f dist/arm64/benchmark ]; then
              lipo -create \
                dist/x86_64/benchmark \
                dist/arm64/benchmark \
                -output dist/universal/benchmark
              chmod +x dist/universal/benchmark
            elif [ -f dist/arm64/benchmark ]; then
              cp dist/arm64/benchmark dist/universal/benchmark
              chmod +x dist/universal/benchmark
            fi
          else
            # If x86_64 build failed, use arm64 as universal (works via Rosetta)
            echo "x86_64 build not available, using arm64 binary (works on Intel via Rosetta)"
            cp dist/arm64/yankovinator dist/universal/yankovinator
            cp dist/arm64/keyword-generator dist/universal/keyword-generator
            if [ -f dist/arm64/benchmark ]; then
              cp dist/arm64/benchmark dist/universal/benchmark
              chmod +x dist/universal/benchmark
            fi
          fi
          
          chmod +x dist/universal/yankovinator dist/universal/keyword-generator
      
      - name: Verify universal binaries
        run: |
          file dist/universal/yankovinator
          file dist/universal/keyword-generator
          if command -v lipo &> /dev/null; then
            lipo -info dist/universal/yankovinator || echo "Binary info check skipped"
          fi
      
      - name: Create archives
        run: |
          cd dist/universal
          if [ -f benchmark ]; then
            tar -czf ../yankovinator-universal.tar.gz yankovinator keyword-generator benchmark
          else
            tar -czf ../yankovinator-universal.tar.gz yankovinator keyword-generator
          fi
          cd ../arm64
          if [ -f benchmark ]; then
            tar -czf ../yankovinator-arm64.tar.gz yankovinator keyword-generator benchmark
          else
            tar -czf ../yankovinator-arm64.tar.gz yankovinator keyword-generator
          fi
          if [ -f ../x86_64/yankovinator ]; then
            cd ../x86_64
            if [ -f benchmark ]; then
              tar -czf ../yankovinator-x86_64.tar.gz yankovinator keyword-generator benchmark
            else
              tar -czf ../yankovinator-x86_64.tar.gz yankovinator keyword-generator
            fi
          fi
          cd ../..
      
      - name: Upload universal binary
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: |
            dist/yankovinator-universal.tar.gz
            dist/yankovinator-arm64.tar.gz
            dist/yankovinator-x86_64.tar.gz
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: create-universal
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: release-binaries
          path: dist
      
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create checksums
        run: |
          cd dist
          for file in *.tar.gz; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "${file}.sha256"
            fi
          done
          echo "Checksums:"
          cat *.sha256 || true
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Yankovinator ${{ steps.get_version.outputs.version }}
            
            ### Downloads
            
            - **Universal Binary** (recommended): `yankovinator-universal.tar.gz` - Works on both Intel and Apple Silicon Macs
            - **Intel (x86_64)**: `yankovinator-x86_64.tar.gz` - For Intel-based Macs
            - **Apple Silicon (arm64)**: `yankovinator-arm64.tar.gz` - For Apple Silicon Macs
            
            ### Installation
            
            ```bash
            # Download and extract
            tar -xzf yankovinator-universal.tar.gz
            
            # Move to a directory in your PATH (e.g., /usr/local/bin)
            sudo mv yankovinator keyword-generator /usr/local/bin/
            
            # Or to ~/.local/bin (if in PATH)
            mkdir -p ~/.local/bin
            mv yankovinator keyword-generator ~/.local/bin/
            ```
            
            ### Verification
            
            ```bash
            # Verify installation
            yankovinator --help
            keyword-generator --help
            ```
            
            ### Checksums
            
            See the `.sha256` files for verification.
          files: |
            dist/yankovinator-universal.tar.gz
            dist/yankovinator-universal.tar.gz.sha256
            dist/yankovinator-x86_64.tar.gz
            dist/yankovinator-x86_64.tar.gz.sha256
            dist/yankovinator-arm64.tar.gz
            dist/yankovinator-arm64.tar.gz.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
